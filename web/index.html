<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="index.css" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Gloria+Hallelujah&display=swap" rel="stylesheet" />
		<title>Document</title>
	</head>
	<body>
		<main>
			<h1>Upload video!</h1>
			<div id="upload-region">
				<input type="file" id="file" accept="video/*" />
				<div id="upload-region-message">Drop file here</div>
			</div>
		</main>
		<script>
			const uploadRegion = document.getElementById("upload-region");
			const uploadRegionMessage = document.getElementById("upload-region-message");
			const file = document.getElementById("file");

			uploadRegion.addEventListener("dragenter", (ev) => {
				if (ev.currentTarget.contains(ev.relatedTarget)) {
					return;
				}
				if (!(ev.dataTransfer.items.length === 1 && ev.dataTransfer.items[0].type.startsWith("video/"))) {
					return;
				}
				uploadRegion.classList.add("file-hover");
			});

			uploadRegion.addEventListener("dragleave", (ev) => {
				if (ev.currentTarget.contains(ev.relatedTarget)) {
					return;
				}
				uploadRegion.classList.remove("file-hover");
			});

			let progressRegex = /Progress\(([0-9.]+)\)/;
			let completedRegex = /Completed/;
			let errorRegex = /Error\((.+)\)/;

			function watchProgress(id) {
				const socket = new WebSocket(`ws://localhost:3000/status_ws?t=${id}`);

				socket.addEventListener("open", () => {
					console.log("websocket open");
				});

				socket.addEventListener("message", (ev) => {
					console.log("message", ev.data);

					let message = null;

					let progressMatch =  ev.data.match(progressRegex);
					let completedMatch = ev.data.match(completedRegex);
					let errorMatch = 	 ev.data.match(errorRegex);
					if (progressMatch) {
						message = `Progress: ${(progressMatch[1] * 100).toFixed(0)}%`;
					} else if (completedMatch) {
						message = `Completed!`;
					} else if (errorMatch) {
						message = `Error:<br><div>${errorMatch[1]}</div>`;
					} else {
						message = "Unknown message";
					}

					uploadRegionMessage.innerHTML = message;
				});

				socket.addEventListener("close", (ev) => {
					console.log("websocket close", ev);
					uploadRegionMessage.innerHTML = "Drop file here";
				});

				socket.addEventListener("error", (err) => {
					console.log("websocket error", err);
				});

				return socket;
			}

			let currentSocket = null;
			const urlParams = new URLSearchParams(window.location.search);
			const queryToken = urlParams.get("t");
			if (queryToken && !Number.isNaN(queryToken)) {
				currentSocket = watchProgress(queryToken);
			}

			file.addEventListener("change", async (e) => {
				uploadRegion.classList.remove("file-hover");

				const file = e.target.files[0];
				const formData = new FormData();
				formData.append("file", file);
				formData.append("file2", file);

				console.log("file", file);

				uploadRegionMessage.innerHTML = "Uploading...";

				let [isOk, taskId] = await fetch("http://localhost:3000/submit", {
					method: "POST",
					body: formData,
				})
					.then(async (res) => [res.ok, await res.text()])
					.then(([isOk, taskId]) => {
						console.log(isOk, taskId);
						return [isOk, taskId];
					})
					.catch((err) => {
						uploadRegionMessage.innerHTML = "Error!";
						console.log(err);
						return [false, null];
					});

				if (!isOk) {
					return;
				}

				// this reloads the page
				window.location.search = `t=${taskId}`;
			});
		</script>
	</body>
</html>
